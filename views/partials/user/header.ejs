<!-- Header -->
<header class="fixed-top">
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
           <button class="hamburger-menu" id="hamburgerMenu" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <a class="navbar-brand" href="/home">CareZon</a>
            
            <!-- Sidebar Overlay -->
            <div class="sidebar-overlay" id="sidebarOverlay"></div>

                <!-- Sidebar Navigation -->
                <div class="sidebar-nav" id="sidebarNav">
                    <div class="sidebar-header">
                        <span class="sidebar-brand">CareZon</span>
                        <button class="sidebar-close" id="sidebarClose" aria-label="Close menu">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="nav-item">
                            <a class="nav-link" href="/home">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/about">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/products/shop">Shop</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/contact">Contact</a>
                        </li>
                    </ul>
                </div>    
                <!-- Header Right Section -->
                <div class="header-right d-flex align-items-center">
                    <!-- Mobile Search Icon -->
                    <div class="mobile-search-icon me-3" id="mobileSearchIcon">
                        <i class="fas fa-search"></i>
                    </div>

                    <!-- Search Field (Hidden on account pages) -->
                    <div class="search-container me-3">
                        <button type="button" class="mobile-search-close" id="mobileSearchClose">
                            <i class="fas fa-times"></i>
                        </button>
                        <form class="search-form">
                            <div class="search-input-wrapper">
                                <input type="text" class="form-control search-input" placeholder="Search for products..." id="searchInput" autocomplete="off" spellcheck="false">
                                <button type="button" class="cancel-btn" id="cancelBtn" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="submit" class="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="search-suggestions" id="searchSuggestions"></div>
                        </form>
                    </div>
                    
                    <!-- Sign Up Button -->
                    <% if (!user) { %>
                        <a href="/signUp" class="btn btn-outline-primary signup-btn me-3">Sign Up</a>
                    <% } %>
                    
                    <!-- User Profile Dropdown -->
                    <div class="dropdown me-3">
                        <a href="#" class="text-dark dropdown-toggle profile-icon d-flex flex-column align-items-center" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle fs-4"></i>
                            <span class="icon-label"> <%= user ? user.fullName : "Account" %> </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            <!-- Show different menu items based on login status -->
                            <% if (locals.user) { %>
                                <li>
                                    <a class="dropdown-item" href="/profile">
                                        <i class="fas fa-user me-2"></i> Profile
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/account/orders">
                                        <i class="fas fa-shopping-bag me-2"></i> My Orders
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/cart">
                                        <i class="fas fa-shopping-cart me-2"></i> Cart
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/account/address">
                                        <i class="fas fa-map-marker-alt me-2"></i> Manage Address
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/account/wishlists">
                                        <i class="fas fa-heart me-2"></i> Favorites
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/account/wallet">
                                        <i class="fas fa-wallet me-2"></i> Wallet
                                    </a>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="/logOut">
                                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                                    </a>
                                </li>
                            <% } else { %>
                                <li>
                                    <a class="dropdown-item" href="/signIn">
                                        <i class="fas fa-sign-in-alt me-2"></i> Sign In
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="/signUp">
                                        <i class="fas fa-user-plus me-2"></i> Sign Up
                                    </a>
                                </li>
                            <% } %>
                        </ul>
                    </div>
                    
                    <!-- Cart and Wishlist Icons (Visible only when signed in) -->
                    <% if (locals.user) { %>
                        <div class="icon-container me-3">
                            <a href="/cart" class="text-dark cart-icon d-flex flex-column align-items-center position-relative">
                                <i class="fas fa-shopping-cart fs-4"></i>
                                <span class="cart-count-badge" id="cartCountBadge">0</span>
                                <span class="icon-label">Cart</span>
                            </a>
                        </div>
                        <div class="icon-container">
                            <a href="/account/wishlists" class="text-dark wishlist-icon d-flex flex-column align-items-center">
                                <i class="fas fa-heart fs-4"></i>
                                <span class="icon-label">Wishlist</span>
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </nav>
</header>

<script>
    // Header JavaScript - Only initialize if not on account pages
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we're on an account page (has sidebar)
        const isAccountPage = document.querySelector('.account-page-wrapper') !== null;
        
        // Hide search on account pages
        if (isAccountPage) {
            const searchContainer = document.querySelector('.search-container');
            const mobileSearchIcon = document.querySelector('.mobile-search-icon');
            if (searchContainer) {
                searchContainer.style.display = 'none';
            }
            if (mobileSearchIcon) {
                mobileSearchIcon.style.display = 'none';
            }
            return; // Don't initialize search functionality on account pages
        }

        // Search functionality for non-account pages
        initializeSearchFunctionality();
    });

    function initializeSearchFunctionality() {
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const performSearch = debounce(async (query) => {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            if (!suggestionsContainer) return;
            
            suggestionsContainer.innerHTML = '';

            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/products/search-suggestions?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (!data.success || data.suggestions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                suggestionsContainer.style.display = 'block';
                data.suggestions.forEach(product => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.innerHTML = `
                        <img src="${product.image || '/images/default-product.jpg'}" alt="${product.name}" class="suggestion-image">
                        <div class="suggestion-details">
                            <span class="suggestion-name">${product.name}</span>
                            <span class="suggestion-brand">${product.brand}</span>
                        </div>
                    `;
                    suggestionItem.addEventListener('click', () => {
                        addToSearchHistory(product.name);
                        window.location.href = `/products/shop?search=${encodeURIComponent(product.name)}`;
                    });
                    suggestionsContainer.appendChild(suggestionItem);
                });
            } catch (error) {
                console.error('Search error:', error);
                suggestionsContainer.style.display = 'none';
            }
        }, 300);

        // Search history management
        function getSearchHistory() {
            try {
                const history = localStorage.getItem('searchHistory');
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }

        function addToSearchHistory(term) {
            try {
                let history = getSearchHistory();
                history = history.filter(item => item !== term);
                history.unshift(term);
                history = history.slice(0, 5);
                localStorage.setItem('searchHistory', JSON.stringify(history));
            } catch (e) {
                console.error('Error saving search history:', e);
            }
        }

        function showSearchHistory() {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            if (!suggestionsContainer) return;
            
            const history = getSearchHistory();
            suggestionsContainer.innerHTML = '';
            
            if (history.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            suggestionsContainer.style.display = 'block';
            
            history.forEach(term => {
                const historyItem = document.createElement('div');
                historyItem.className = 'search-history-item';
                historyItem.innerHTML = `
                    <i class="far fa-clock history-icon"></i>
                    <div class="history-content">
                        <span class="history-term">${term}</span>
                    </div>
                `;
                historyItem.addEventListener('click', () => {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = term;
                        suggestionsContainer.style.display = 'none';
                        window.location.href = `/products/shop?search=${encodeURIComponent(term)}`;
                    }
                });
                suggestionsContainer.appendChild(historyItem);
            });
        }

        // Event listeners
        const searchInput = document.getElementById('searchInput');
        const cancelBtn = document.getElementById('cancelBtn');
        const searchForm = document.querySelector('.search-form');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                toggleCancelButton();
                
                if (e.target.value.trim() === '') {
                    showSearchHistory(); 
                } else {
                    performSearch(e.target.value);
                }
            });

            searchInput.addEventListener('focus', (e) => {
                toggleCancelButton();
                
                if (e.target.value.trim() === '') {
                    showSearchHistory();
                } else if (e.target.value.length >= 2) {
                    performSearch(e.target.value);
                }
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                const suggestionsContainer = document.getElementById('searchSuggestions');
                
                searchInput.value = '';
                if (suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
                toggleCancelButton();
                searchInput.focus(); 
            });
        }

        if (searchForm) {
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (query) {
                    addToSearchHistory(query);
                    window.location.href = `/products/shop?search=${encodeURIComponent(query)}`;
                }
            });
        }

        // Click outside to close suggestions
        document.addEventListener('click', (e) => {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            const searchContainer = document.querySelector('.search-container');
            if (suggestionsContainer && searchContainer && !searchContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });

        function toggleCancelButton() {
            if (!searchInput || !cancelBtn) return;
            
            if (searchInput.value.trim() !== '') {
                cancelBtn.style.display = 'flex';
                searchInput.classList.add('has-text');
            } else {
                cancelBtn.style.display = 'none';
                searchInput.classList.remove('has-text');
            }
        }
    }

    // Function to update cart count
        async function updateCartCount() {
            try {
                const response = await fetch('/cart/count');
                const data = await response.json();
                
                if (data.success) {
                    const badge = document.getElementById('cartCountBadge');
                    if (badge) {
                        badge.textContent = data.count;
                        badge.setAttribute('data-count', data.count);
                    }
                }
            } catch (error) {
                console.error('Error fetching cart count:', error);
            }
        }

        // Mobile Search Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileSearchIcon = document.getElementById('mobileSearchIcon');
            const mobileSearchClose = document.getElementById('mobileSearchClose');
            const searchContainer = document.querySelector('.search-container');
            const headerRight = document.querySelector('.header-right');

            function closeMobileSearch() {
                if (searchContainer && headerRight) {
                    searchContainer.classList.remove('mobile-active');
                    headerRight.classList.remove('search-active');
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                    const suggestionsContainer = document.getElementById('searchSuggestions');
                    if (suggestionsContainer) {
                        suggestionsContainer.style.display = 'none';
                    }
                    const cancelBtn = document.getElementById('cancelBtn');
                    if (cancelBtn) {
                        cancelBtn.style.display = 'none';
                    }
                }
            }

            if (mobileSearchIcon && searchContainer) {
                mobileSearchIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    searchContainer.classList.add('mobile-active');
                    headerRight.classList.add('search-active');
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                });
            }

            if (mobileSearchClose && searchContainer) {
                mobileSearchClose.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeMobileSearch();
                });
            }

            // Close mobile search when clicking outside
            document.addEventListener('click', function(e) {
                if (searchContainer && searchContainer.classList.contains('mobile-active')) {
                    if (!searchContainer.contains(e.target) && e.target !== mobileSearchIcon) {
                        closeMobileSearch();
                    }
                }
            });

            // Prevent closing when clicking inside search container
            if (searchContainer) {
                searchContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        // Sidebar Navigation Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            const sidebarNav = document.getElementById('sidebarNav');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarClose = document.getElementById('sidebarClose');

            function openSidebar() {
                sidebarNav.classList.add('active');
                sidebarOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            function closeSidebar() {
                sidebarNav.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            if (hamburgerMenu) {
                hamburgerMenu.addEventListener('click', openSidebar);
            }

            if (sidebarClose) {
                sidebarClose.addEventListener('click', closeSidebar);
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', closeSidebar);
            }

            // Close sidebar when clicking on a link
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', closeSidebar);
            });
        });

        // Initialize cart count on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Only update cart count if user is logged in
            const isUserLoggedIn = document.querySelector('.cart-icon') !== null;
            if (isUserLoggedIn) {
                updateCartCount();
            }
        });
</script>

